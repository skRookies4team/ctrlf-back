# ctrlf-back 프로젝트 규칙

## 프로젝트 개요
- 멀티 모듈 Spring Boot 백엔드 (Java 17, Gradle)
- 서비스: chat-service(9001), education-service(9002), infra-service(9003), quiz-service(9004), api-gateway(8080)
- 공통 라이브러리: common-security, common-dto, common-utils, common-constants
- 인프라: PostgreSQL(5432), Keycloak(8090), AWS S3

## 코딩 스타일
- Java 코드는 Spring Boot 3.x, Jakarta EE 9+ 표준 사용
- 패키지 구조: `com.ctrlf.{service}.{domain}.{layer}` (controller/service/repository/entity/dto)
- Lombok 사용 (Getter/Setter/NoArgsConstructor/AllArgsConstructor 등)
- JPA 엔티티는 `@Entity`, `@Table(schema = "...")` 명시
- DTO는 `RagRequestDtos`, `VideoResponseDtos` 같은 정적 중첩 클래스 패턴 사용
  - Request DTO: `{Action}Request` (예: `UploadRequest`, `PresignRequest`)
  - Response DTO: `{Action}Response` (예: `UploadResponse`, `PresignResponse`)
  - 요청/응답을 명확히 구분하여 네이밍
- 예외 처리는 `@ControllerAdvice` + `GlobalExceptionHandler` 사용

## 하위 도메인 구조 규칙
- 새로운 하위 도메인 추가 시 반드시 다음 레이어를 생성:
  - `{domain}/controller/`: REST API 엔드포인트 (`@RestController`, `@RequestMapping`)
  - `{domain}/service/`: 비즈니스 로직 (`@Service`, 인터페이스 + 구현체 패턴 선택적)
  - `{domain}/repository/`: 데이터 접근 (`JpaRepository` 상속)
  - `{domain}/entity/`: JPA 엔티티 (`@Entity`, `@Table`)
  - `{domain}/dto/`: 요청/응답 DTO (또는 `dto/request/`, `dto/response/` 분리 가능)
- 선택적 레이어:
  - `{domain}/client/`: 외부 API 클라이언트 (예: `VideoAiClient`, `RagAiClient`)
  - `{domain}/exception/`: 도메인별 예외 클래스
  - `{domain}/config/`: 도메인별 설정 클래스

## 데이터베이스
- Flyway 마이그레이션 사용 (`src/main/resources/db/migration/V{version}__{name}.sql`)
- 스키마 분리: `education`, `infra`, `chat` 등
- UUID를 PK로 사용 (PostgreSQL `uuid` 타입)
- `created_at`, `updated_at`, `deleted_at` (소프트 삭제) 패턴

## API 설계
- RESTful API, Swagger/OpenAPI 문서화
- 인증: Keycloak JWT (Bearer Token)
- CORS: `common-security`의 `SecurityConfig`에서 `http://localhost:5173` 허용
- 응답 DTO는 `@AllArgsConstructor` + `@Getter` 패턴

## 서비스별 특성
- **education-service**: 교육 영상 생성 플로우 (DRAFT → SCRIPT_READY → SCRIPT_REVIEW_REQUESTED → SCRIPT_APPROVED → READY → FINAL_REVIEW_REQUESTED → PUBLISHED)
- **infra-service**: S3 Presigned URL, RAG 문서 관리 (임베딩 요청/상태 조회)
- **chat-service**: 챗봇 세션/메시지 관리, FAQ

## 문서 구조
- 프로젝트 문서는 `docs/` 폴더에 서비스별/도메인별로 구성
  - `docs/architecture/`: 시스템 아키텍처, 전체 플로우 (`system_architecture.md`, `education-video-flow.md` 등)
  - `docs/{service}/{domain}/api/`: API 스펙 문서 (`*_api_spec.md`)
  - `docs/{service}/{domain}/flow/`: 비즈니스 플로우 문서 (`*_flow.md`)
  - `docs/{service}/{domain}/test/`: 테스트 시나리오/결과 (`*_test-*.md`)
- 코드 작성/수정 시 관련 문서를 참고하여 일관성 유지

## 테스트
- 로컬 테스트: `SPRING_PROFILES_ACTIVE=local,local-seed`
- API 테스트: `docs/{service}/{domain}/test/` 참고

## 협업 규칙
- **브랜치 전략**: 기능 개발은 `feature/{이슈번호}-{간단설명}` (예: `feature/123-add-video-api`)
- **커밋 메시지**: `feat:`, `fix:`, `refactor:`, `docs:`, `test:` 등 Conventional Commits 사용
- **PR 작성**: `.github/PULL_REQUEST_TEMPLATE/pr.md` 템플릿 사용
  - 작업 개요, 변경 내용, 테스트 방법, 관련 이슈 명시
- **코드 리뷰 체크리스트**:
  - 하위 도메인 구조 준수 (controller/service/repository/entity/dto)
  - DTO Request/Response 구분 명확
  - 예외 처리 적절 (GlobalExceptionHandler 활용)
  - Swagger/OpenAPI 문서화 (`@Operation`, `@ApiResponse` 등)
  - Flyway 마이그레이션 파일명 규칙 준수 (`V{version}__{name}.sql`)
- **네이밍 컨벤션**:
  - 클래스: PascalCase (예: `VideoService`, `EducationVideo`)
  - 메서드/변수: camelCase (예: `createVideo`, `videoId`)
  - 상수: UPPER_SNAKE_CASE (예: `MAX_RETRY_COUNT`)
  - 패키지: 소문자, 점 구분 (예: `com.ctrlf.education.video`)

## 주의사항
- AWS S3: `AWS_PROFILE` 환경변수 필요 (예: `AWS_PROFILE=sk_4th_team04`)
- 개발 환경: Docker Compose로 Postgres/Keycloak 기동
- JPA 엔티티 스캔: `@EntityScan(basePackages = "com.ctrlf.{service}")` 명시 필요

## 응답 언어
- 모든 응답은 한국어로 작성
